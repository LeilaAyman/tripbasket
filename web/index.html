<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    Alternatively, build your application passing the --base-href parameter
    specifying the new root path of your web app.

    Fore more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="tripsbasket">

  


  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png" />

  <!-- SEO & Open Graph tags -->
  <title>TripBasket - Discover Amazing Travel Destinations</title>
  <meta name="description" content="Explore top travel destinations around the world with TripBasket. Book trips, discover hidden gems, and create unforgettable memories with trusted travel agencies.">
  <meta name="keywords" content="travel, trips, destinations, booking, travel agency, vacation, tourism">
  <meta name="author" content="TripBasket">
  
  <!-- Open Graph tags -->
  <meta property="og:title" content="TripBasket - Discover Amazing Travel Destinations">
  <meta property="og:description" content="Explore top travel destinations around the world with TripBasket. Book trips, discover hidden gems, and create unforgettable memories.">
  <meta property="og:image" content="/assets/images/optimized/200611101955-01-egypt-dahab.webp">
  <meta property="og:url" content="https://tripsbasket.com">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="TripBasket">
  
  <!-- Twitter Card tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="TripBasket - Discover Amazing Travel Destinations">
  <meta name="twitter:description" content="Explore top travel destinations around the world with TripBasket.">
  <meta name="twitter:image" content="/assets/images/optimized/200611101955-01-egypt-dahab.webp">
  <!-- Critical resource preconnects -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://firebase.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://identitytoolkit.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://securetoken.googleapis.com" crossorigin>
  
  <!-- DNS prefetch for less critical resources -->
  <link rel="dns-prefetch" href="https://storage.googleapis.com">
  <link rel="dns-prefetch" href="https://apis.google.com">
  <link rel="dns-prefetch" href="https://accounts.google.com">
  
  <!-- Hero image preload for LCP optimization - ensure LCP detection -->
  <link rel="preload" as="image" href="/assets/images/optimized/200611101955-01-egypt-dahab_lg.webp" fetchpriority="high">
  <link rel="preload" as="image" href="/assets/images/optimized/200611101955-01-egypt-dahab_md.webp" media="(max-width: 768px)" fetchpriority="high">
  <link rel="preload" as="image" href="/assets/images/optimized/200611101955-01-egypt-dahab_sm.webp" media="(max-width: 480px)" fetchpriority="high">
  
  <!-- Preload critical CSS/JS for better FCP -->
  <link rel="preload" as="style" href="/flutter.js">
  
  <!-- Ultra-critical CSS inlined for performance -->
  <style>
    /* Minimal critical CSS for fastest FCP */
    *{box-sizing:border-box;margin:0;padding:0}
    html{line-height:1.15;-webkit-text-size-adjust:100%}
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;font-size:14px;background:#f1f4f8;overflow-x:hidden;-webkit-font-smoothing:antialiased}
    
    /* Flutter performance optimizations */
    flt-glass-pane,flt-scene-host{pointer-events:none;position:absolute;top:0;left:0;will-change:transform}
    flt-semantics-host{position:absolute;top:0;left:0;transform:translate3d(0,0,0);contain:layout style paint}
    flt-renderer,flt-clip,flt-opacity,flt-offset,flt-transform{contain:layout style paint}
    flutter-view{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden}
    
    /* Lazy image loading support */
    img[loading="lazy"]{opacity:0;transition:opacity 0.3s}
    img[loading="lazy"].loaded{opacity:1}
    
    /* Performance-critical styles only */
    .loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:16px;color:#333;z-index:1000}
    
    /* Removed loading screen styles */
    
    /* Mobile-first responsive */
    @media (max-width:768px){body{font-size:12px}}
  </style>

  <!-- Status Bar color in Safari browser (iOS) and PWA -->
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f1f4f8">
  <meta name="theme-color" media="(prefers-color-scheme: dark)"  content="#1d2428">

  <link rel="manifest" href="manifest.json">
  
</head>
<body>
  <!-- Minimal loading indicator -->
  <div id="loading-indicator" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; color: #666;">
    Loading...
  </div>
  
  <script>
// Force cache clear and reload
if (window.location.search.includes('refresh=true')) {
  if ('caches' in window) {
    caches.keys().then(names => {
      names.forEach(name => {
        caches.delete(name);
      });
    });
  }
  localStorage.clear();
  sessionStorage.clear();
  window.location.href = window.location.pathname;
}

// Service worker with aggressive update handling
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/flutter_service_worker.js')
    .then(reg => {
      // Force update check
      reg.update();
      
      if (reg.waiting) {
        reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        window.location.reload(true);
      }
      
      reg.onupdatefound = () => {
        const newWorker = reg.installing;
        newWorker.onstatechange = () => {
          if (newWorker.state === 'installed') {
            if (navigator.serviceWorker.controller) {
              // New content is available, force reload
              newWorker.postMessage({ type: 'SKIP_WAITING' });
              setTimeout(() => window.location.reload(true), 100);
            }
          }
        };
      };
    });
}

// Check for updates every 30 seconds
setInterval(() => {
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    navigator.serviceWorker.getRegistration().then(reg => {
      if (reg) reg.update();
    });
  }
}, 30000);
</script>
  <script>
    {{flutter_js}}
    {{flutter_build_config}}
    
    // Ultra-aggressive performance optimization
    let firebaseLoaded = false;
    let userInteracted = false;
    let loadingQueue = new Map();
    
    // Performance-first module loading
    const loadModule = (name, url, priority = 'low') => {
      if (loadingQueue.has(name)) return loadingQueue.get(name);
      
      const promise = new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = url;
        
        // Use performance-optimized loading based on priority
        if (priority === 'high') {
          script.async = false;
          script.defer = false;
        } else {
          script.async = true;
          script.defer = true;
        }
        
        script.onload = () => {
          console.log(`âœ“ Loaded ${name} (${priority} priority)`);
          resolve();
        };
        script.onerror = () => {
          console.warn(`âœ— Failed to load ${name}`);
          reject();
        };
        
        // Add to document when main thread is idle
        if ('requestIdleCallback' in window && priority !== 'high') {
          requestIdleCallback(() => document.head.appendChild(script));
        } else {
          document.head.appendChild(script);
        }
      });
      
      loadingQueue.set(name, promise);
      return promise;
    };
    
    // Firebase modules with on-demand loading
    const firebaseModules = {
      app: 'https://www.gstatic.com/firebasejs/11.7.0/firebase-app-compat.js',
      auth: 'https://www.gstatic.com/firebasejs/11.7.0/firebase-auth-compat.js',
      firestore: 'https://www.gstatic.com/firebasejs/11.7.0/firebase-firestore-compat.js',
      analytics: 'https://www.gstatic.com/firebasejs/11.7.0/firebase-analytics-compat.js',
      performance: 'https://www.gstatic.com/firebasejs/11.7.0/firebase-performance-compat.js'
    };
    
    // Expose global Firebase loaders for Flutter app
    window.loadFirebaseAuth = async () => {
      await loadModule('app', firebaseModules.app, 'high');
      return loadModule('auth', firebaseModules.auth, 'high');
    };
    
    window.loadFirebaseFirestore = async () => {
      await loadModule('app', firebaseModules.app, 'high');  
      return loadModule('firestore', firebaseModules.firestore, 'high');
    };
    
    window.loadFirebaseAnalytics = async () => {
      await loadModule('app', firebaseModules.app, 'low');
      return loadModule('analytics', firebaseModules.analytics, 'low');
    };
    
    // Only load Firebase when actually needed - never preemptively
    const loadCriticalFirebase = async () => {
      if (firebaseLoaded) return;
      firebaseLoaded = true;
      
      console.log('ðŸ”¥ Loading critical Firebase modules...');
      
      // Load only app module initially
      await loadModule('app', firebaseModules.app, 'high');
      
      console.log('âœ“ Critical Firebase loaded');
    };
    
    // Ultra-restrictive interaction detection
    const criticalInteractions = ['click', 'touchend', 'keydown'];
    const onCriticalInteraction = (e) => {
      if (!userInteracted) {
        userInteracted = true;
        console.log('ðŸŽ¯ User interaction detected, loading Firebase...');
        
        // Use scheduler if available for better performance
        if ('scheduler' in window && 'postTask' in window.scheduler) {
          window.scheduler.postTask(() => loadCriticalFirebase(), { priority: 'background' });
        } else if ('requestIdleCallback' in window) {
          requestIdleCallback(() => loadCriticalFirebase(), { timeout: 5000 });
        } else {
          setTimeout(() => loadCriticalFirebase(), 100);
        }
        
        // Remove listeners immediately
        criticalInteractions.forEach(event => 
          document.removeEventListener(event, onCriticalInteraction, { passive: true, capture: true })
        );
      }
    };
    
    // Add interaction listeners with passive: true for better performance
    criticalInteractions.forEach(event => 
      document.addEventListener(event, onCriticalInteraction, { passive: true, capture: true })
    );
    
    // Ultra-performance lazy loading implementation
    function initializeLazyLoading() {
      // Use native lazy loading if supported, otherwise polyfill
      if ('loading' in HTMLImageElement.prototype) {
        console.log('ðŸ–¼ï¸ Using native lazy loading');
        
        // Apply lazy loading to all images
        document.querySelectorAll('img:not([loading])').forEach(img => {
          img.loading = 'lazy';
          img.classList.add('lazy-native');
        });
      } else {
        console.log('ðŸ–¼ï¸ Using Intersection Observer lazy loading');
        
        // Intersection Observer polyfill
        const imageObserver = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              
              // Load image
              if (img.dataset.src) {
                img.src = img.dataset.src;
                img.classList.add('loaded');
                delete img.dataset.src;
              }
              
              // Stop observing this image
              observer.unobserve(img);
            }
          });
        }, {
          // Load images when they're 100px from viewport
          rootMargin: '100px 0px',
          threshold: 0.1
        });
        
        // Observe all images with data-src
        document.querySelectorAll('img[data-src]').forEach(img => {
          imageObserver.observe(img);
        });
      }
      
      // Responsive WebP image optimization
      const webpSupported = supportsWebP();
      if (webpSupported) {
        console.log('ðŸŽ¨ WebP format supported, optimizing images');
        
        // Replace image sources with WebP versions where available
        document.querySelectorAll('img[data-webp]').forEach(img => {
          const webpSrc = img.dataset.webp;
          if (webpSrc) {
            img.src = webpSrc;
            img.classList.add('webp-optimized');
          }
        });
      }
    }
    
    // WebP support detection
    function supportsWebP() {
      const canvas = document.createElement('canvas');
      canvas.width = 1;
      canvas.height = 1;
      return canvas.toDataURL('image/webp').indexOf('webp') !== -1;
    }
    
    // Handle Firebase Auth email verification links
    function handleFirebaseAuth() {
      const urlParams = new URLSearchParams(window.location.search);
      const mode = urlParams.get('mode');
      const oobCode = urlParams.get('oobCode');
      
      if (mode === 'verifyEmail' && oobCode) {
        // Show a loading message
        document.body.innerHTML = `
          <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: Arial, sans-serif;">
            <div style="text-align: center;">
              <h2>Verifying your email...</h2>
              <p>Please wait while we verify your email address.</p>
              <div style="margin-top: 20px;">
                <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto;"></div>
              </div>
            </div>
          </div>
          <style>
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
          </style>
        `;
        
        // Firebase will handle the verification automatically
        setTimeout(() => {
          window.location.href = '/';
        }, 3000);
        
        return true;
      }
      return false;
    }
    
    // Check if this is an auth link before loading Flutter
    if (!handleFirebaseAuth()) {
      // Load Flutter app with standard configuration
      _flutter.loader.load({
      onEntrypointLoaded: function(engineInitializer) {
        engineInitializer.initializeEngine({
          renderer: "html",
          useColorEmoji: true
        }).then(function(appRunner) {
          appRunner.runApp();
          
          // Hide loading indicator when Flutter loads
          const loadingIndicator = document.getElementById('loading-indicator');
          if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
          }
          
          console.log('âœ… Flutter app loaded');
          
          // Initialize lazy loading for all images
          initializeLazyLoading();
        });
      }
    });
    }
  </script>
</body>
</html>
